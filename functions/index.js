const functions = require('firebase-functions/v2');
const admin = require('firebase-admin');
const fetch = require('node-fetch');

admin.initializeApp();
const embeddingBest = [
  -0.4096187651157379,
  -0.15140588581562042,
  -0.5917255282402039,
  1.131152868270874,
  -0.3660757839679718,
  -0.1443014293909073,
  0.19353070855140686,
  -0.12584851682186127,
  -0.17888124287128448,
  0.10944744199514389,
  -0.4423016607761383,
  -0.1557505875825882,
  0.3359938859939575,
  -0.3093489706516266,
  -0.08259239792823792,
  0.32237178087234497,
  0.28496289253234863,
  -0.47988948225975037,
  -0.0222025066614151,
  -0.15286801755428314,
  0.24913501739501953,
  -0.9263468384742737,
  -0.3154924809932709,
  -0.09840023517608643,
  0.4820283055305481,
  0.250125527381897,
  0.055799081921577454,
  0.24958397448062897,
  -0.3420109748840332,
  0.05848543345928192,
  0.6372338533401489,
  -0.35765016078948975,
  -0.34436699748039246,
  -0.22363010048866272,
  -0.244866281747818,
  -0.2910420298576355,
  -0.3145916759967804,
  -0.1534343659877777,
  0.033451877534389496,
  0.03323334455490112,
  -0.2857436239719391,
  -0.013576000928878784,
  0.6676416993141174,
  0.15806317329406738,
  0.16017574071884155,
  -0.28592684864997864,
  0.29253295063972473,
  -0.018398180603981018,
  0.2211807668209076,
  0.18883806467056274,
  -0.015622906386852264,
  -0.4406968355178833,
  0.028381742537021637,
  0.09815636277198792,
  0.5136429071426392,
  0.6401543617248535,
  0.28869614005088806,
  -0.06467923521995544,
  0.2096928209066391,
  -0.07181300222873688,
  0.9535090923309326,
  -0.2200680673122406,
  -0.06028779596090317,
  0.5608445405960083,
  -0.04069947823882103,
  -0.2505553364753723,
  -0.6952276825904846,
  0.20568907260894775,
  1.0263466835021973,
  0.3027891218662262,
  0.06771709024906158,
  -0.37390202283859253,
  -0.08874248713254929,
  0.012196779251098633,
  -0.1384245604276657,
  -1.131237506866455,
  -0.4532701373100281,
  -0.18108128011226654,
  0.4933660924434662,
  0.08761599659919739,
  -0.5242308378219604,
  -0.17250721156597137,
  0.17415079474449158,
  0.11176685243844986,
  -0.2610089182853699,
  0.6142361760139465,
  0.11739402264356613,
  -0.5264251232147217,
  0.15515275299549103,
  -0.28919875621795654,
  0.12065254151821136,
  0.05303162708878517,
  0.06630788743495941,
  -0.24500307440757751,
  -0.6081836819648743,
  0.103704072535038,
  -0.6010348796844482,
  0.08496119827032089,
  -0.04414990544319153,
  -0.42197227478027344,
  -0.46542179584503174,
  0.03885312378406525,
  -0.33524852991104126,
  0.2317919135093689,
  -0.020439565181732178,
  0.5718700885772705,
  1.0134857892990112,
  -0.29004767537117004,
  0.22223597764968872,
  0.02256089448928833,
  0.017398232594132423,
  0.03629329800605774,
  -0.2679712474346161,
  -0.23313304781913757,
  -0.17051765322685242,
  -0.576951801776886,
  0.48841729760169983,
  -0.33236435055732727,
  -0.46679550409317017,
  0.11376030743122101,
  -0.13075843453407288,
  0.12750765681266785,
  -0.22113165259361267,
  -0.02624060958623886,
  0.6058520078659058,
  -0.014994487166404724,
  -0.24464088678359985,
  0.09691144526004791,
  -0.3160797357559204,
  0.2513323426246643,
  -0.19973348081111908,
  0.2722940444946289,
  -0.20489220321178436,
  0.4043574333190918,
  0.04234854131937027,
  0.7356475591659546,
  -0.36887821555137634,
  -0.22759844362735748,
  -0.013682588934898376,
  0.3609776496887207,
  0.21070295572280884,
  0.13213902711868286,
  -0.7558174133300781,
  -0.35832369327545166,
  0.08752050250768661,
  0.26763442158699036,
  -0.3586980104446411,
  -0.1997033804655075,
  -0.018409252166748047,
  0.09502322971820831,
  -0.4842032194137573,
  0.02875811606645584,
  -0.726072371006012,
  -0.28152552247047424,
  -0.5254315733909607,
  0.2612723112106323,
  0.1822599321603775,
  0.6600399017333984,
  0.20158298313617706,
  -0.4290619492530823,
  -0.011254742741584778,
  -0.03733544051647186,
  -0.3192521929740906,
  0.3532930910587311,
  0.3983771800994873,
  -0.09887462109327316,
  -0.2091522514820099,
  0.33323824405670166,
  0.04510621726512909,
  0.41226401925086975,
  0.16825641691684723,
  -0.11394399404525757,
  0.3272280693054199,
  -0.6273219585418701,
  0.11012479662895203,
  -0.5056678056716919,
  -0.195646271109581,
  -0.21883970499038696,
  -0.4092004895210266,
  0.3285404443740845,
  -0.18182620406150818,
  0.5061454772949219,
  0.19267912209033966,
  0.6037260890007019,
  -0.33439043164253235,
  -0.42049315571784973,
  -0.24079552292823792,
  0.7127803564071655,
  -0.25703784823417664,
  0.3254173696041107,
  0.3792804181575775,
  -0.21748220920562744,
  -0.5070813894271851,
  -0.8563810586929321,
  0.25118449330329895,
  0.5543718934059143,
  -0.3730674982070923,
  0.03175649046897888,
  0.06482566893100739,
  -0.2466205209493637,
  -0.009290769696235657,
  -2.8331751823425293,
  0.3017767369747162,
  -0.05854503810405731,
  0.8847421407699585,
  0.5861292481422424,
  0.006812840700149536,
  0.3099859952926636,
  -0.6879726648330688,
  0.34353217482566833,
  -0.3860972225666046,
  -0.09764520823955536,
  0.03016570210456848,
  -0.48544415831565857,
  0.41843539476394653,
  -0.2757973372936249,
  0.7487183213233948,
  -0.10704749822616577,
  -0.0789337158203125,
  0.686357319355011,
  -0.1781403124332428,
  0.19807186722755432,
  0.5909947752952576,
  0.17700576782226562,
  0.1494569331407547,
  -0.09048519283533096,
  -0.07842342555522919,
  0.5932143926620483,
  -0.14993511140346527,
  -0.15584984421730042,
  0.23397213220596313,
  -0.22836929559707642,
  -0.07319460809230804,
  -0.30530428886413574,
  -0.37068402767181396,
  -0.8695446252822876,
  -0.015835732221603394,
  -0.2433624267578125,
  -0.05534951388835907,
  -0.4861372411251068,
  0.06136280298233032,
  -0.25277456641197205,
  0.20199310779571533,
  -0.13118202984333038,
  0.11421427130699158,
  0.004767969250679016,
  0.24853521585464478,
  -0.2217348963022232,
  0.14064742624759674,
  -0.6386823058128357,
  0.3982819616794586,
  -0.11155001819133759,
  0.07341860234737396,
  0.0979728251695633,
  -0.5550835728645325,
  0.3714231550693512,
  0.007201075553894043,
  -0.053902581334114075,
  -0.04423811286687851,
  0.303158700466156,
  0.15261703729629517,
  -0.4711584448814392,
  0.032519347965717316,
  0.5256094336509705,
  -0.4699309468269348,
  0.5509634613990784,
  0.000889509916305542,
  0.12883099913597107,
  -0.07515346258878708,
  -0.27893486618995667,
  0.021510809659957886,
  0.0421554297208786,
  0.19788186252117157,
  -0.2921171188354492,
  -0.3339388966560364,
  -0.25713858008384705,
  0.5084211826324463,
  -0.4487849771976471,
  0.3450709581375122,
  -0.3494168519973755,
  0.5004673004150391,
  -0.4002512991428375,
  0.08199165761470795,
  -0.23186033964157104,
  -0.014371544122695923,
  -0.28035953640937805,
  -0.09220269322395325,
  -0.015560336410999298,
  0.8876736760139465,
  -0.09680584073066711,
  -0.7011590003967285,
  -0.08895765244960785,
  0.24224871397018433,
  -0.12012656778097153,
  0.15286701917648315,
  -0.15979599952697754,
  -0.27102968096733093,
  0.9562945365905762,
  0.2110852599143982,
  -0.36252516508102417,
  -0.11529427021741867,
  0.19396743178367615,
  0.23630665242671967,
  0.06819651275873184,
  -0.047149598598480225,
  0.2571970820426941,
  -0.4756303131580353,
  0.2817739248275757,
  -0.04816713556647301,
  -0.30993396043777466,
  -0.2645775079727173,
  0.2771987318992615,
  -0.15281321108341217,
  -0.5465369820594788,
  -0.24889443814754486,
  0.15313592553138733,
  -7.6902923583984375,
  -0.9562508463859558,
  0.36081111431121826,
  0.29337894916534424,
  0.6756772398948669,
  -0.5186338424682617,
  -0.3117758631706238,
  -0.07198119163513184,
  -0.16522854566574097,
  -0.3508285880088806,
  0.11225766688585281,
  0.05354953557252884,
  -0.35077330470085144,
  -0.8384846448898315,
  -0.2941657602787018,
  -0.5982329845428467,
  -0.8755608797073364,
  0.16577541828155518,
  -0.10986829549074173,
  0.6609882712364197,
  -0.15624430775642395,
  -0.3549920320510864,
  0.08315279334783554,
  0.2923806309700012,
  0.1615212857723236,
  -0.07766154408454895,
  -0.03881970793008804,
  0.1498439610004425,
  0.017824027687311172,
  -0.01609046757221222,
  0.22862336039543152,
  0.026295755058526993,
  0.30479374527931213,
  -0.13496720790863037,
  0.42131507396698,
  -0.03671140968799591,
  -0.10211527347564697,
  0.43251603841781616,
  0.009276160970330238,
  -0.6526193022727966,
  -0.5293099284172058,
  0.046117380261421204,
  -0.5377039909362793,
  0.183761328458786,
  0.0199897401034832,
  -0.47860950231552124,
  -0.19557756185531616,
  2.2611546516418457,
  -0.35425519943237305,
  0.11685644090175629,
  -0.672520637512207,
  -0.09035862982273102,
  0.2912451922893524,
  -0.5496155619621277,
  0.0008085817098617554,
  -0.46120235323905945,
  0.11217518150806427,
  -0.3342248499393463,
  0.024445606395602226,
  -0.1463649570941925,
  0.8287783861160278,
  -0.518668532371521,
  -0.021976761519908905,
  0.16136522591114044,
  0.08564277738332748,
  0.03117629885673523,
  -0.5959645509719849,
  -0.1239631250500679,
  0.3857288062572479,
  0.7117985486984253,
  -0.17646926641464233,
  0.6853860020637512,
  -0.20994341373443604,
  -0.22486263513565063,
  0.3069241940975189,
  0.3458484411239624,
  0.24162374436855316,
  -0.0058071911334991455,
  -0.4226330816745758,
  0.6929859519004822,
  0.5415427088737488,
  0.5410658121109009,
  0.22836962342262268,
  -0.18779489398002625,
  -0.1244828850030899,
  0.2382056564092636,
  0.3298320770263672,
  -0.6173139810562134,
  -0.201217919588089,
  0.22931841015815735,
  0.05571083724498749,
  -0.4861852526664734,
  -0.12315557152032852,
  0.12215057760477066,
  0.09315852075815201,
  -0.7418274283409119,
  0.37343111634254456,
  -0.3708266019821167,
  0.05227182060480118,
  0.17652559280395508,
  0.17164745926856995,
  0.5132145285606384,
  0.03168690204620361,
  0.1947527527809143,
  -0.7392011284828186,
  0.6733850240707397,
  0.07690048962831497,
  0.00015088915824890137,
  0.03806181252002716,
  -0.1947622299194336,
  -0.35261595249176025,
  -0.04033779352903366,
  0.11688452959060669,
  -0.088340625166893,
  0.048162996768951416,
  -0.7375774383544922,
  -0.0480993390083313,
  -0.07170917838811874,
  -0.4560387134552002,
  -0.45539921522140503,
  -0.4712274670600891,
  -0.6470385789871216,
  -0.0373346284031868,
  -0.38855618238449097,
  6.433615207672119,
  -0.5744103789329529,
  -0.6482178568840027,
  -0.05083557963371277,
  0.1325605809688568,
  0.009089171886444092,
  -0.6037363409996033,
  -0.04362105578184128,
  0.49145710468292236,
  -0.5165306329727173,
  -0.4387347102165222,
  0.04972298443317413,
  0.5117086172103882,
  0.15515939891338348,
  -0.5760511159896851,
  -0.34678903222084045,
  0.09080944210290909,
  0.2773250937461853,
  -1.111013412475586,
  -0.13520896434783936,
  0.367515504360199,
  0.07832326740026474,
  0.0030856579542160034,
  -0.5576483607292175,
  -0.48082149028778076,
  -0.5074997544288635,
  -0.236283078789711,
  -0.619835376739502,
  0.29219865798950195,
  0.18820849061012268,
  0.20585283637046814,
  -0.057730577886104584,
  0.07626783102750778,
  0.2354557067155838,
  -0.2197130024433136,
  0.4665552079677582,
  0.10223206132650375,
  0.5582196712493896,
  0.13026270270347595,
  -0.022307023406028748,
  -0.217540442943573,
  0.6958152651786804,
  -0.2709174156188965,
  -0.16247524321079254,
  -0.47734180092811584,
  0.03050391376018524,
  0.5977634191513062,
  -0.2345588207244873,
  0.03521701693534851,
  -0.4053373336791992,
  0.1361716240644455,
  -0.2175806164741516,
  0.33655092120170593,
  0.28789645433425903,
  -0.35217317938804626,
  -0.1840960532426834,
  -0.2921879291534424,
  -0.2367132306098938,
  -0.34701263904571533,
  -0.21977095305919647,
  0.4593222141265869,
  -0.23793505132198334,
  -0.09645894169807434,
  -0.33706536889076233,
  0.3934454023838043,
  0.10162365436553955,
  -0.3979034423828125,
  0.9818037748336792,
  0.032016754150390625,
  -0.12439943850040436,
  0.5630850195884705,
  0.7072283029556274,
  0.1597428023815155,
  0.5726460218429565,
  -0.13707220554351807,
  0.1838797777891159,
  -0.39993202686309814,
  -0.08756642043590546,
  0.17538973689079285,
  1.0358755588531494,
  -0.516629695892334,
  -0.8401325345039368,
  0.16182538866996765,
  -0.3849680721759796,
  -0.040916018187999725,
  0.4602620005607605,
  -0.06338205933570862,
  0.20903664827346802,
  0.10974696278572083,
  -0.025377940386533737,
  -0.00016321241855621338,
  0.6241893768310547,
  -0.10409227013587952,
  -0.017764560878276825,
  -0.37689536809921265,
  0.33744925260543823,
  0.4164453148841858,
  -0.054009824991226196,
  0.00700022280216217,
  -0.7574419379234314,
  -0.15289539098739624,
  -0.22819297015666962,
  0.7299590110778809,
  0.18395036458969116,
  0.2986343801021576,
  0.21404874324798584,
  -0.6854464411735535,
  0.4745858311653137,
  0.17031267285346985,
  -0.20325031876564026,
  0.27902472019195557,
  0.6803823709487915,
  -0.26313477754592896,
  0.10336587578058243,
  0.019857101142406464,
  -0.13420045375823975,
  -1.4432601928710938,
  -0.0888667181134224,
  0.19112473726272583,
  0.5635358691215515,
  -0.2287026047706604,
  0.03691035509109497,
  0.3007996082305908,
  0.36817315220832825,
  1.152059555053711,
  -0.16822019219398499,
  0.18938672542572021,
  -0.12169510126113892,
  -0.33511167764663696,
  -0.34920284152030945,
  0.33055806159973145,
  -0.5653786659240723,
  0.4138600826263428,
  -0.17099052667617798,
  0.8428930044174194,
  -0.07153110206127167,
  -0.09364798665046692,
  0.2408732771873474,
  0.14322547614574432,
  0.8261518478393555,
  0.758184015750885,
  0.32981422543525696,
  1.0986061096191406,
  -0.53782057762146,
  -0.09516089409589767,
  -0.29467514157295227,
  -0.30892741680145264,
  -0.3328894078731537,
  0.39707767963409424,
  -0.05068431794643402,
  -0.4629051387310028,
  0.11273983120918274,
  0.2715771198272705,
  -0.520281970500946,
  -0.6684182286262512,
  0.2942712903022766,
  -0.12341392040252686,
  -0.20671546459197998,
  -0.2543541491031647,
  0.6866559982299805,
  0.10220879316329956,
  -0.10997021198272705,
  0.4039483666419983,
  -0.1566908210515976,
  -0.011337369680404663,
  -2.471738338470459,
  -0.20546114444732666,
  0.16967570781707764,
  -0.3477817177772522,
  -0.5757207274436951,
  -0.13003239035606384,
  0.4921615719795227,
  1.0001426935195923,
  0.032608240842819214,
  0.3239426016807556,
  0.2753714621067047,
  -0.5054137706756592,
  -0.582493245601654,
  0.3202452063560486,
  -0.012143708765506744,
  0.02020058035850525,
  0.19121965765953064,
  0.30933165550231934,
  -0.050559595227241516,
  0.09463198482990265,
  0.0041588544845581055,
  0.6094613671302795,
  -0.10977118462324142,
  0.5219286680221558,
  -1.215606927871704,
  -0.24310053884983063,
  -0.25615400075912476,
  0.8563730716705322,
  0.11184780299663544,
  0.14778488874435425,
  -0.03875800594687462,
  0.26084163784980774,
  -0.8412782549858093,
  -0.18962916731834412,
  0.46884578466415405,
  -0.27807724475860596,
  -0.6053162813186646,
  0.19918549060821533,
  0.4401886463165283,
  0.3740523159503937,
  -0.35192787647247314,
  -0.14849308133125305,
  -0.0857226625084877,
  0.4910823106765747,
  0.21866407990455627,
  0.15665285289287567,
  0.10693424940109253,
  -0.027970299124717712,
  0.30216705799102783,
  0.1276322305202484,
  0.22389456629753113,
  0.17142513394355774,
  -0.24764502048492432,
  -0.44247061014175415,
  0.14203062653541565,
  0.08178628981113434,
  -0.22085008025169373,
  0.14532947540283203,
  -0.3868410587310791,
  0.25298526883125305,
  -0.09609536826610565,
  0.6274377107620239,
  0.2855161428451538,
  0.5922681093215942,
  -0.5172896385192871,
  -0.0688353180885315,
  -0.2324150651693344,
  -0.5425136089324951,
  0.2775873839855194,
  0.2501484155654907,
  0.15670786798000336,
  -0.11805190145969391,
  0.47791188955307007,
  -0.025067467242479324,
  -0.5087952613830566,
  0.3339488208293915,
  -0.09925705194473267,
  -0.5201025009155273,
  0.09679265320301056,
  0.3286142647266388,
  0.3580765128135681,
  -0.34009847044944763,
  -0.2744868993759155,
  -0.2080247700214386,
  0.31732696294784546,
  0.43992161750793457,
  -0.09194216132164001,
  -0.20739583671092987,
  0.266221821308136,
  -0.8285079002380371,
  0.5928815603256226,
  0.1395927220582962,
  0.10083702206611633,
  -0.31848686933517456,
  0.6125915050506592,
  -0.10389506816864014,
  0.2994931638240814,
  0.3608205318450928,
  0.23151589930057526,
  0.36031949520111084,
  -0.41368231177330017,
  -0.13066363334655762,
  0.051909297704696655,
  -0.15834665298461914,
  0.1171126663684845,
  0.15841130912303925,
  -0.9353345632553101,
  0.06691361218690872,
  1.059998631477356,
  -0.02489258348941803,
  -0.19725042581558228,
  0.12979818880558014,
  -0.17144997417926788,
  0.3631102740764618,
  0.10615262389183044,
  -0.09744884073734283,
  0.6257238984107971,
  0.10018221288919449,
  -0.1901332139968872,
  1.6771446466445923,
  0.43497124314308167,
  0.07763488590717316,
  0.23797796666622162,
  -0.2702464163303375,
  -0.2517108619213104,
  -0.3563283383846283,
  0.025335341691970825,
  0.07199862599372864,
  -0.8292249441146851,
  -0.1823478639125824,
  0.43391403555870056,
  -0.10638269782066345,
  -0.3302268385887146,
  0.2880929410457611,
  0.4811435341835022,
  0.34086906909942627,
  0.4209563434123993,
  0.12591493129730225,
  0.5208392143249512,
  0.021760381758213043,
  -0.20677141845226288,
  -0.08314432948827744,
  -0.6162664890289307,
  -0.5397645235061646,
  -0.650081217288971,
  -0.6659029722213745,
  0.48443499207496643,
  0.6047290563583374,
  0.3461529016494751,
  0.5841636657714844,
  0.6759709119796753,
  0.10641736537218094,
  0.28729480504989624,
  0.6405446529388428,
  0.15498872101306915,
  0.15003681182861328,
  0.23186185956001282,
  0.5158715844154358,
  0.06724832952022552,
  0.10906880348920822,
  -0.27520379424095154,
  -0.16194888949394226,
  -0.015540670603513718
];
const embeddingWorst = [
  -0.3438122868537903,
  -0.6004908680915833,
  -0.4166715443134308,
  1.177018165588379,
  0.010981395840644836,
  -0.13330140709877014,
  -0.5220484733581543,
  -0.1165103167295456,
  -0.26022472977638245,
  0.527186393737793,
  -0.13637900352478027,
  0.509253978729248,
  0.6680586338043213,
  -0.008179739117622375,
  -0.9122459888458252,
  0.39247459173202515,
  0.9046404361724854,
  -0.25944992899894714,
  0.050418317317962646,
  -0.3115428686141968,
  0.0007827877998352051,
  -1.1324090957641602,
  0.20563139021396637,
  0.3540637195110321,
  0.5128618478775024,
  0.24135512113571167,
  -0.25955039262771606,
  0.33856624364852905,
  -0.18761533498764038,
  -0.19172009825706482,
  -0.3402674198150635,
  -0.4058770537376404,
  -0.43559521436691284,
  -0.2544974088668823,
  -0.3119852542877197,
  0.33058661222457886,
  -0.5480338335037231,
  -0.03221423923969269,
  -0.35172370076179504,
  0.4393627941608429,
  -0.303036630153656,
  -0.3701236844062805,
  0.7436302900314331,
  0.5417944192886353,
  0.11536015570163727,
  0.5487942695617676,
  0.29096800088882446,
  -0.22047549486160278,
  -0.399245023727417,
  -0.8344048261642456,
  -0.3655811846256256,
  -0.788395345211029,
  -0.43928271532058716,
  0.2842944860458374,
  0.13014928996562958,
  0.14071807265281677,
  0.5605875849723816,
  -0.06577067077159882,
  -0.30843493342399597,
  -0.6176208853721619,
  1.132098913192749,
  -0.03008269891142845,
  -0.44530144333839417,
  0.42886263132095337,
  0.27971360087394714,
  -0.6190599799156189,
  -1.0577208995819092,
  -0.588068962097168,
  0.5615776181221008,
  0.044853344559669495,
  -0.07771649211645126,
  -0.10738871991634369,
  -0.27879321575164795,
  -0.3781699240207672,
  -0.35520610213279724,
  -0.45442837476730347,
  -0.11406035721302032,
  -0.4556237757205963,
  -0.19699448347091675,
  0.151491180062294,
  -0.33368176221847534,
  0.3434200882911682,
  0.08190295845270157,
  0.3920532464981079,
  -0.08057228475809097,
  0.41182827949523926,
  0.17694486677646637,
  -0.18992727994918823,
  -0.22227628529071808,
  -0.48650529980659485,
  -0.31851261854171753,
  0.15451548993587494,
  0.20255827903747559,
  -0.1212015300989151,
  -0.6863793134689331,
  0.11951027810573578,
  -0.41476666927337646,
  -0.6311997175216675,
  -0.7331510186195374,
  -0.022481195628643036,
  -0.527058482170105,
  -0.005870611406862736,
  -0.132611483335495,
  0.5601404905319214,
  -0.014332756400108337,
  0.4328996539115906,
  0.7334732413291931,
  0.05282748490571976,
  0.8092653155326843,
  -0.5668503642082214,
  0.09645149111747742,
  0.07675536721944809,
  -0.46588027477264404,
  0.20318211615085602,
  -0.42224961519241333,
  -0.18690159916877747,
  0.1697859764099121,
  -0.06603344529867172,
  0.17955471575260162,
  -0.060507312417030334,
  -0.4414716064929962,
  -0.3087887763977051,
  0.6064589619636536,
  0.11672830581665039,
  0.6374148726463318,
  0.3916596472263336,
  0.0800875797867775,
  0.1487550288438797,
  -0.17008942365646362,
  0.17693254351615906,
  -0.4423038065433502,
  0.6586292386054993,
  -0.5563188791275024,
  0.4649718701839447,
  0.17528104782104492,
  1.2679613828659058,
  -0.24877643585205078,
  -0.020286649465560913,
  -0.0410471186041832,
  0.2156917303800583,
  -0.07084476947784424,
  0.5741338729858398,
  -0.8079610466957092,
  -0.4079074263572693,
  0.24095027148723602,
  0.07040444016456604,
  0.47703325748443604,
  0.21435615420341492,
  -0.17254966497421265,
  -0.2723711133003235,
  -0.761553943157196,
  -0.008412799797952175,
  -0.768606424331665,
  0.06992226839065552,
  0.003834731876850128,
  0.17674031853675842,
  -0.2720758318901062,
  0.9418511986732483,
  0.0362052321434021,
  -0.22715094685554504,
  -0.11922493577003479,
  -0.18589353561401367,
  0.19305302202701569,
  -0.19957014918327332,
  -0.25926727056503296,
  -0.5370650291442871,
  -0.37395215034484863,
  0.29189562797546387,
  -0.09468415379524231,
  0.08167821913957596,
  0.2616977095603943,
  -0.27851203083992004,
  -0.014005664736032486,
  -0.37644127011299133,
  0.15560321509838104,
  -0.3407594561576843,
  -0.668341875076294,
  -0.28448545932769775,
  -0.37695521116256714,
  -0.09605993330478668,
  -0.5953293442726135,
  0.0842524915933609,
  -0.3420764207839966,
  0.5823531746864319,
  0.3693084120750427,
  -0.6183472871780396,
  0.13265882432460785,
  -0.03766745328903198,
  0.33366990089416504,
  0.09897404909133911,
  0.8278313875198364,
  -0.001628737896680832,
  -0.4854135513305664,
  -0.25094783306121826,
  0.012680187821388245,
  -1.106826663017273,
  -0.3742409944534302,
  -0.1479278951883316,
  0.22247207164764404,
  -0.25429242849349976,
  0.01241208054125309,
  -2.4461536407470703,
  0.06854399293661118,
  0.5650980472564697,
  -0.08360343426465988,
  0.5377393364906311,
  0.05131463706493378,
  0.4518614411354065,
  -0.3586110770702362,
  -0.028256148099899292,
  0.0862593725323677,
  0.12846589088439941,
  -0.3072507083415985,
  -0.30882519483566284,
  -0.3942342698574066,
  -0.14820067584514618,
  0.08171285688877106,
  0.46901631355285645,
  -0.16891959309577942,
  -0.019512338563799858,
  -0.05053642392158508,
  0.15930595993995667,
  0.3321142792701721,
  0.562565803527832,
  0.801857590675354,
  -0.08982302248477936,
  0.005754977464675903,
  0.09526247531175613,
  0.3224739134311676,
  -0.21301642060279846,
  0.20452435314655304,
  -0.21389777958393097,
  0.1663319170475006,
  -0.3371818959712982,
  -0.3574443459510803,
  -0.7618502378463745,
  -0.10754859447479248,
  0.12503236532211304,
  -0.11349722743034363,
  -0.2680526375770569,
  -0.03611764311790466,
  -0.2092350870370865,
  0.496219277381897,
  -0.12333005666732788,
  0.34755802154541016,
  0.14737549424171448,
  -0.06444922089576721,
  0.03506764769554138,
  -0.3299449384212494,
  -0.17260971665382385,
  0.22139835357666016,
  0.0675981342792511,
  0.12065959721803665,
  0.01040215790271759,
  0.014237672090530396,
  0.361794650554657,
  -0.026919908821582794,
  0.7033194899559021,
  -0.04440268874168396,
  -0.01877009868621826,
  0.3566424548625946,
  -0.8536855578422546,
  -0.17421457171440125,
  0.5993642210960388,
  -0.2957063615322113,
  -0.4502434730529785,
  -0.03292379900813103,
  -0.588733434677124,
  0.2154253125190735,
  -0.3060469627380371,
  -0.48495835065841675,
  0.2875135838985443,
  0.2190682739019394,
  0.10645218193531036,
  -0.3501845598220825,
  -0.06401997804641724,
  0.320742666721344,
  -0.2448534369468689,
  -0.09115070849657059,
  0.01198200136423111,
  0.4896133244037628,
  0.6458975076675415,
  0.0324103906750679,
  -0.5393691062927246,
  -0.08729556947946548,
  0.01714222878217697,
  0.19224493205547333,
  0.16059616208076477,
  -1.126441478729248,
  -0.6911022663116455,
  -0.49176025390625,
  -0.1499103456735611,
  -0.39113762974739075,
  -0.21027402579784393,
  0.557248055934906,
  -0.4173547625541687,
  -0.6367667317390442,
  0.3065868616104126,
  0.39554691314697266,
  0.11418148130178452,
  0.10193712264299393,
  0.4536115229129791,
  0.41523289680480957,
  0.33083128929138184,
  0.007812649011611938,
  0.16311822831630707,
  -0.12528961896896362,
  0.42093798518180847,
  -0.267088383436203,
  -0.32238417863845825,
  -0.7200508713722229,
  -0.17321045696735382,
  0.008173100650310516,
  -0.5375715494155884,
  -0.1430378556251526,
  0.23175999522209167,
  -9.216517448425293,
  -0.15663567185401917,
  0.6891727447509766,
  -0.05218140035867691,
  0.9205353260040283,
  -0.44217875599861145,
  -0.30027174949645996,
  -0.11568855494260788,
  0.398761510848999,
  0.6384327411651611,
  -0.6183828115463257,
  -0.3260501027107239,
  -0.053739868104457855,
  -0.7433125972747803,
  0.15863481163978577,
  -0.04408051073551178,
  0.12640699744224548,
  0.3066025674343109,
  -0.3856385350227356,
  0.38883405923843384,
  -0.24312451481819153,
  -0.23509863018989563,
  0.5245528221130371,
  0.4782216250896454,
  -0.30732327699661255,
  0.06038713455200195,
  -0.14917917549610138,
  -0.03131081908941269,
  0.0385575145483017,
  -0.6732720136642456,
  0.01626698672771454,
  -0.1202903613448143,
  0.09961338341236115,
  -0.3885476589202881,
  0.6107450723648071,
  -0.12359866499900818,
  0.6496990919113159,
  0.578993022441864,
  -0.33482247591018677,
  0.5313452482223511,
  -0.15671397745609283,
  0.47099775075912476,
  0.12461669743061066,
  0.378096342086792,
  0.21410754323005676,
  -0.4585874080657959,
  -0.7196199893951416,
  2.0145299434661865,
  0.01741119846701622,
  0.2933979630470276,
  -0.2740176320075989,
  0.2620771527290344,
  -0.3668419122695923,
  0.2330183982849121,
  -0.11372857540845871,
  -0.7744502425193787,
  0.271829754114151,
  -0.07523249089717865,
  0.6485346555709839,
  -0.42424529790878296,
  0.22225132584571838,
  -0.004484027624130249,
  -0.4331257939338684,
  0.5437241792678833,
  0.43643978238105774,
  0.003888934850692749,
  -0.06788910925388336,
  -0.5562523007392883,
  0.8777373433113098,
  0.6071643829345703,
  0.5976112484931946,
  0.21318894624710083,
  0.3083818852901459,
  -0.007200360298156738,
  0.25292354822158813,
  0.21018928289413452,
  0.25703394412994385,
  -0.43928730487823486,
  0.07994028925895691,
  -0.19679832458496094,
  0.6872668266296387,
  -0.2900550663471222,
  -0.11040031164884567,
  -0.022022491320967674,
  -0.41130194067955017,
  -0.027352146804332733,
  0.24836139380931854,
  -0.3238608241081238,
  0.019398435950279236,
  0.23944227397441864,
  -0.22136925160884857,
  -0.24658510088920593,
  0.2140675187110901,
  0.4618120789527893,
  0.3560514748096466,
  0.08225500583648682,
  -0.047009244561195374,
  -0.7403615117073059,
  0.11537855118513107,
  0.10788486897945404,
  -0.038578860461711884,
  -0.02297399938106537,
  0.5491000413894653,
  0.33688512444496155,
  0.20858269929885864,
  0.7120751738548279,
  -0.15051031112670898,
  -0.34224647283554077,
  0.6234147548675537,
  0.054923854768276215,
  -0.5405470728874207,
  -0.9613307118415833,
  0.16292336583137512,
  0.05289392173290253,
  -0.7354542016983032,
  -0.24310731887817383,
  0.2970278561115265,
  0.0005518496036529541,
  0.12677668035030365,
  0.003537256270647049,
  0.011202830821275711,
  -0.35973745584487915,
  -0.3499075770378113,
  -0.723256528377533,
  7.526216506958008,
  -0.5737391114234924,
  -0.7586893439292908,
  0.5584699511528015,
  -0.18521010875701904,
  -0.6729626655578613,
  -0.28183111548423767,
  0.28106775879859924,
  0.0036904187873005867,
  -0.297852098941803,
  0.04823579266667366,
  0.016011465340852737,
  0.11745448410511017,
  0.5862708687782288,
  -0.3385148346424103,
  -0.4196324944496155,
  -0.3846849799156189,
  0.5795274972915649,
  -0.573165774345398,
  0.15003062784671783,
  0.5705339908599854,
  0.04144484922289848,
  0.21159204840660095,
  -0.15804068744182587,
  -0.553169846534729,
  -0.004953624680638313,
  0.44501757621765137,
  -0.02107115089893341,
  0.18994265794754028,
  0.042719241231679916,
  0.6565610766410828,
  0.294813334941864,
  0.1225048378109932,
  -0.41535037755966187,
  -0.5386800169944763,
  -0.009807392954826355,
  0.0701148509979248,
  1.1123714447021484,
  0.47652509808540344,
  -0.44228339195251465,
  -0.17027436196804047,
  0.12164708226919174,
  -0.15917141735553741,
  -0.19064156711101532,
  -0.20435065031051636,
  -0.19992202520370483,
  0.2514383792877197,
  -0.15497708320617676,
  -0.19778412580490112,
  -0.12819397449493408,
  0.7496596574783325,
  0.0034960955381393433,
  0.5553978681564331,
  -0.20353321731090546,
  -0.3140972852706909,
  -0.770758867263794,
  0.144362673163414,
  0.3099944293498993,
  -0.004852365702390671,
  -0.7039688229560852,
  -0.10126187652349472,
  0.1709669828414917,
  0.004731088876724243,
  0.1727762520313263,
  0.027787934988737106,
  0.10912243276834488,
  -0.39792579412460327,
  0.2587648034095764,
  -0.20651371777057648,
  0.4837820529937744,
  -0.026509268209338188,
  0.43842869997024536,
  -0.4245735704898834,
  0.3078054189682007,
  -0.23355050384998322,
  -0.45279157161712646,
  -0.25292491912841797,
  -0.21831613779067993,
  0.03877050802111626,
  0.6437956094741821,
  0.04591400921344757,
  -0.545881986618042,
  0.11568590998649597,
  -0.2190341353416443,
  -0.1688636839389801,
  -0.16071321070194244,
  -0.0913519412279129,
  -0.30298060178756714,
  0.23212482035160065,
  -0.15302199125289917,
  -0.11767364293336868,
  -0.44727087020874023,
  -0.004549466073513031,
  0.10398165136575699,
  -0.054346852004528046,
  -0.21894478797912598,
  0.34502583742141724,
  0.297254741191864,
  0.06259132921695709,
  -0.6915268898010254,
  -0.07185088843107224,
  -0.5515432953834534,
  0.635687530040741,
  0.031506091356277466,
  -0.4436458349227905,
  -0.09728479385375977,
  0.6034714579582214,
  -0.19469428062438965,
  0.0022538751363754272,
  -0.11458295583724976,
  0.32166558504104614,
  -0.5162189602851868,
  -0.06347241997718811,
  -0.3678666353225708,
  0.7984176874160767,
  -0.11693242192268372,
  -0.9143236875534058,
  -0.4875555634498596,
  -0.2094542682170868,
  -0.1563829928636551,
  -0.3212850093841553,
  0.005607228726148605,
  0.2545502483844757,
  0.06396761536598206,
  -0.14996257424354553,
  0.335571825504303,
  0.1241706907749176,
  0.17867407202720642,
  -1.2347785234451294,
  -0.1578712910413742,
  0.2935950756072998,
  -0.3696315586566925,
  0.22976316511631012,
  0.3018141984939575,
  0.12259314209222794,
  0.25064605474472046,
  0.5084101557731628,
  0.14599692821502686,
  -0.6185439825057983,
  0.3810718059539795,
  0.19913341104984283,
  1.0678807497024536,
  1.014582872390747,
  0.38156843185424805,
  0.0385696142911911,
  -0.08838246762752533,
  -0.00251123309135437,
  -0.18512852489948273,
  -0.14236405491828918,
  0.04924853891134262,
  0.22521230578422546,
  -0.19240200519561768,
  -0.12802505493164062,
  -0.0563269779086113,
  -0.05978386104106903,
  -0.16273942589759827,
  0.2639687955379486,
  -0.393473744392395,
  -0.1595429927110672,
  0.6094423532485962,
  0.4684379994869232,
  -0.9596078991889954,
  0.09990422427654266,
  -0.14804787933826447,
  -0.3808552920818329,
  -2.0649356842041016,
  0.19054965674877167,
  -0.14677514135837555,
  -0.29990798234939575,
  0.04157112538814545,
  0.4073108434677124,
  -0.08739443123340607,
  0.12536680698394775,
  -0.16126224398612976,
  0.2703600525856018,
  -0.20755526423454285,
  -0.13266895711421967,
  -0.40331482887268066,
  -0.17695555090904236,
  0.25801700353622437,
  0.1656651496887207,
  -0.11290045082569122,
  0.7349642515182495,
  -0.5285702347755432,
  0.35253292322158813,
  0.42376023530960083,
  -0.18442514538764954,
  -0.10178549587726593,
  0.10791593790054321,
  -0.6564787030220032,
  0.04771893844008446,
  -0.199589341878891,
  0.5169239044189453,
  0.11833535134792328,
  0.12157487869262695,
  -0.41773441433906555,
  -0.09703399240970612,
  -0.29373326897621155,
  0.04021262004971504,
  0.2305717021226883,
  -0.44835811853408813,
  -0.530192494392395,
  -0.29726696014404297,
  0.06913675367832184,
  0.7408953309059143,
  0.1811893731355667,
  -0.434994637966156,
  0.35747024416923523,
  0.5834439396858215,
  -0.13853949308395386,
  -0.15438710153102875,
  0.30934110283851624,
  0.24388554692268372,
  -0.259813517332077,
  -0.015874186530709267,
  0.5493123531341553,
  0.33597832918167114,
  0.15199604630470276,
  0.11433205008506775,
  -0.3056122362613678,
  0.5774970054626465,
  0.14073015749454498,
  -0.07343091070652008,
  -0.45659953355789185,
  -0.01678943634033203,
  0.6462113857269287,
  -0.09096896648406982,
  0.713144063949585,
  0.5383918285369873,
  0.6970415115356445,
  0.06587263941764832,
  -0.19534102082252502,
  -0.5816084146499634,
  -0.05642605572938919,
  0.38611745834350586,
  0.12150125205516815,
  -0.07824662327766418,
  -0.024578124284744263,
  0.08052730560302734,
  -0.08444003760814667,
  0.3790745437145233,
  -0.39612850546836853,
  -0.17713521420955658,
  0.5628454089164734,
  0.14284886419773102,
  -0.008817720226943493,
  0.3339615762233734,
  -0.1840112805366516,
  -0.035887911915779114,
  -0.6340599060058594,
  0.4206409454345703,
  -0.2509083151817322,
  0.7789101600646973,
  -0.36912593245506287,
  -0.5913021564483643,
  -0.22994369268417358,
  -0.06287254393100739,
  -0.26242464780807495,
  -0.31187593936920166,
  0.06081780791282654,
  0.2802044451236725,
  0.24764370918273926,
  0.6339626312255859,
  0.01522805541753769,
  -0.32592451572418213,
  -0.4263612627983093,
  0.1390615701675415,
  0.19656842947006226,
  -0.4346744120121002,
  0.025599613785743713,
  -0.2944493889808655,
  0.10554825514554977,
  0.46159687638282776,
  0.34546905755996704,
  0.3510109782218933,
  0.34852874279022217,
  -0.1837826520204544,
  -0.37555959820747375,
  -0.1061871126294136,
  0.6472896337509155,
  0.22799554467201233,
  0.05012451112270355,
  -0.029993664473295212,
  -0.5887379050254822,
  0.9372597932815552,
  -0.5871859788894653,
  -0.39354902505874634,
  0.41343769431114197,
  0.03133407235145569,
  -0.4881031811237335,
  -0.09311021864414215,
  -0.5471072196960449,
  -0.1251995712518692,
  -0.26884374022483826,
  -0.31445372104644775,
  0.07901506125926971,
  -0.045507557690143585,
  0.25541776418685913,
  0.5803831219673157,
  -0.013852030038833618,
  0.5483667254447937,
  0.11509270966053009,
  -0.1961716115474701,
  -0.40269410610198975,
  0.1655094176530838,
  0.6523014903068542,
  0.26615434885025024,
  -0.679102897644043,
  -0.12600088119506836,
  -0.20136398077011108,
  0.5639111995697021,
  -0.13430427014827728,
  0.8872183561325073,
  0.22680333256721497,
  0.1434323638677597,
  0.03699465095996857,
  0.44259291887283325,
  0.05239599943161011,
  0.37774863839149475,
  0.3567681312561035,
  0.3856615424156189,
  0.36552879214286804,
  0.33064043521881104,
  0.10363482683897018,
  0.03286060690879822,
  0.11479480564594269,
  -0.3486207127571106,
  -0.08601712435483932
];

exports.fetchNews = functions.https.onRequest(async (req, res) => {
    const API_KEY = process.env.NEWSCATCHER_API_KEY;
  
    if (!API_KEY) {
      console.error("NewsCatcher API key is missing.");
      res.status(500).send("Internal Server Error: API key is missing.");
      return;
    }
  
    const url = 'https://api.newscatcherapi.com/v2/latest_headlines?lang=en&when=24h&page_size=100&topic=news';
  
    const options = {
      method: 'GET',
      headers: {
        'x-api-key': API_KEY,
      },
    };
  
    try {
      console.log("Fetching latest headlines from NewsCatcher API...");
      const response = await fetch(url, options);
      if (!response.ok) {
        console.error(`NewsCatcher API request failed. Status: ${response.status}`);
        throw new Error(`API request failed with status ${response.status}`);
      }
  
      const result = await response.json();
      console.log("NewsCatcher API response:", result);
  
      const filteredArticles = result.articles.filter(article => {
        const summary = article.summary.toLowerCase();
        const matches = summary.includes('israel') || summary.includes('israeli');
        if (matches) {
          console.log(`Article matches criteria: ${article.title}`);
        }
        return matches;
      });
      console.log("Filtered articles:", filteredArticles);
  
      if (filteredArticles.length === 0) {
        console.warn("No articles found that match the criteria.");
        res.status(200).send({ message: "No articles matching the criteria." });
        return;
      }
  
      const ref = admin.database().ref('news');
  
      const writePromises = filteredArticles.map(async (article) => {
        const existingArticleSnapshot = await ref.orderByChild('title').equalTo(article.title).once('value');
        if (existingArticleSnapshot.exists()) {
          console.log(`Article "${article.title}" already exists. Skipping...`);
          return;
        }
  
        // const articleRef = await ref.push({
        //   title: article.title,
        //   summary: article.summary,
        //   link: article.link,
        //   timestamp: Date.now(),
        //   score: "pending",
        // });

        // const prompt = `Please provide a sentiment analysis score for the following text: "${article.summary}". When calculating the score, consider the greater good of people living in the geographic region known as Israel / Palestine and the impact that's described in the text could have over their future. The score must be a floating point number between 0 and 1 (0 is negative sentiment and 1 is positive sentiment) with up to 6 decimal places. The answer should only contain the number, no additional characters, spaces, or line breaks.`;
        // await askValue(prompt, articleRef.key);

        const articleRef = await ref.push({
          title: article.title,
          summary: article.summary,
          link: article.link,
          timestamp: Date.now(),
          score: "pending",
          embedding: [],
        });

        const cleanedSummary = article.summary.replace(/\s+/g, ' ').trim();
        const embedding = await askEmbedding(cleanedSummary);
        await updateEmbeddingInFirebase(articleRef.key, embedding);
      });
  
      await Promise.all(writePromises);
      console.log("All new articles written to Firebase successfully.");
      res.status(200).send({ message: "Articles stored successfully." });
  
    } catch (error) {
      console.error("Error in fetchNews function:", error.message);
      res.status(500).send("Internal Server Error");
    }
});

//#region  ASK LLM
async function askValue(prompt, key) {
    console.log("Sending sentiment analysis request for article:", key);

    const data = {
        modelURL: "https://api.replicate.com/v1/models/meta/meta-llama-3-70b-instruct/predictions",
        input: {
            prompt: prompt,
        },
    };

    const options = {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            Accept: 'application/json',
        },
        body: JSON.stringify(data),
    };

    try {
        // const response = await fetch(process.env.REPLICATE_API_URL, options);
        const response = await fetch("https://replicate-api-proxy.glitch.me/create_n_get/", options);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log("API Response:", result);
        let score;
        if (Array.isArray(result.output)) {
            const rawScore = result.output.join('').replace(/[^0-9.]/g, '');
            score = parseFloat(rawScore);
        } else {
            score = parseFloat(result.output);
        }

        if (!isNaN(score)) {
            console.log(`Valid score received for article ${key}:`, score);
            await updateScoreInFirebase(key, score);
        } else {
            console.error(`Invalid score received for article ${key}:`, result.output);
        }
    } catch (error) {
        console.error("Error fetching sentiment score:", error);
    }
}
//#endregion

//#region  ASK EMBEDDING MODEL
async function askEmbedding(textInput) {
  console.log("askEmbeddingModel called with:", textInput);
  document.body.style.cursor = "progress";

  try {
      const data = {
          version: "75b33f253f7714a281ad3e9b28f63e3232d583716ef6718f2e46641077ea040a",
          input: {
              inputs: [textInput],
          },
      };
      console.log("Making a Fetch Request", data);
      const options = {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              Accept: 'application/json',
          },
          body: JSON.stringify(data),
      };

      const raw = await fetch(url, options);
      const proxy_said = await raw.json();
      let output = proxy_said.output;
      console.log("Output from Embedding Model:", output);

      return output;
  } catch (error) {
      console.error("Error in askEmbeddingModel:", error);
  } finally {
      document.body.style.cursor = "default";
  }
}
//#endregion


async function updateEmbeddingInFirebase(key, embedding) {
  const newsRef = admin.database().ref(`news/${key}`);
  await newsRef.update({ embedding: embedding });
  console.log(`Embedding successfully updated in Firebase for article ${key}`);
  await calculateScore(key);
}

async function calculateScore(key) {
  const newsRef = admin.database().ref(`news/${key}`);
  const snapshot = await newsRef.once('value');
  const article = snapshot.val();

  if (!article.embedding) {
      console.error(`No embedding found for article ${key}`);
      return;
  }

  const bestScore = cosineSimilarity(article.embedding, embeddingBest);
  const worstScore = cosineSimilarity(article.embedding, embeddingWorst);

  const normalizedScore = (bestScore - worstScore + 1) / 2;

  await newsRef.update({ score: normalizedScore });
  console.log(`Score calculated and updated for article ${key}: ${normalizedScore}`);
  await calculateAndDisplayWeightedAverage();
}

function cosineSimilarity(a, b) {
  const dotProduct = a.reduce((sum, _, i) => sum + a[i] * b[i], 0);
  const magnitudeA = Math.sqrt(a.reduce((sum, val) => sum + val * val, 0));
  const magnitudeB = Math.sqrt(b.reduce((sum, val) => sum + val * val, 0));
  return dotProduct / (magnitudeA * magnitudeB);
}

async function updateScoreInFirebase(key, score) {
    const newsRef = admin.database().ref(`news/${key}`);
    await newsRef.update({ score: score });
    console.log(`Score successfully updated in Firebase for article ${key}`);
    calculateAndDisplayWeightedAverage();
}

async function calculateAndDisplayWeightedAverage() {
    const newsRef = admin.database().ref('news');
    const snapshot = await newsRef.once('value');
    const articles = snapshot.val();
    const keys = Object.keys(articles || {});
    const currentTime = Date.now();
    let totalWeightedScore = 0;
    let totalWeight = 0;

    const decayConstant = 14 * 24 * 60 * 60 * 1000;  // 2 weeks (its days * hrs * mins * secs * ms)

    keys.forEach((key) => {
        const article = articles[key];
        const articleTime = article.timestamp;
        const timeDifference = currentTime - articleTime;
        const weight = Math.exp(-timeDifference / decayConstant);

        if (article.score !== "pending") {
            totalWeightedScore += article.score * weight;
            totalWeight += weight;
        }
    });

    const weightedAverage = totalWeight === 0 ? 0 : totalWeightedScore / totalWeight;
    console.log(`Calculated weighted average score: ${weightedAverage}`);
    await updateMainScore(weightedAverage);
}

async function updateMainScore(weightedAverage) {
    const mainScoreRef = admin.database().ref('mainScore');
    await mainScoreRef.set({ score: weightedAverage });
    console.log("Main score updated successfully.");
}
